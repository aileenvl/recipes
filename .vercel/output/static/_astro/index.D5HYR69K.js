var ee=Object.create,V=Object.defineProperty,te=Object.getOwnPropertyDescriptor,se=Object.getOwnPropertyNames,re=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty,j=(e,s)=>()=>(s||e((s={exports:{}}).exports,s),s.exports),ie=(e,s,a,o)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of se(s))!ne.call(e,n)&&n!==a&&V(e,n,{get:()=>s[n],enumerable:!(o=te(s,n))||o.enumerable});return e},H=(e,s,a)=>(a=e!=null?ee(re(e)):{},ie(V(a,"default",{value:e,enumerable:!0}),e)),X=j(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.isBytes=o,e.number=s,e.bool=a,e.bytes=n,e.hash=w,e.exists=v,e.output=C;function s(l){if(!Number.isSafeInteger(l)||l<0)throw new Error(`positive integer expected, not ${l}`)}function a(l){if(typeof l!="boolean")throw new Error(`boolean expected, not ${l}`)}function o(l){return l instanceof Uint8Array||l!=null&&typeof l=="object"&&l.constructor.name==="Uint8Array"}function n(l,...y){if(!o(l))throw new Error("Uint8Array expected");if(y.length>0&&!y.includes(l.length))throw new Error(`Uint8Array expected of length ${y}, not of length=${l.length}`)}function w(l){if(typeof l!="function"||typeof l.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");s(l.outputLen),s(l.blockLen)}function v(l,y=!0){if(l.destroyed)throw new Error("Hash instance has been destroyed");if(y&&l.finished)throw new Error("Hash#digest() has already been called")}function C(l,y){n(l);let k=y.outputLen;if(l.length<k)throw new Error(`digestInto() expects output buffer of length at least ${k}`)}var S={number:s,bool:a,bytes:n,hash:w,exists:v,output:C};e.default=S}),ae=j(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.add5L=e.add5H=e.add4H=e.add4L=e.add3H=e.add3L=e.rotlBL=e.rotlBH=e.rotlSL=e.rotlSH=e.rotr32L=e.rotr32H=e.rotrBL=e.rotrBH=e.rotrSL=e.rotrSH=e.shrSL=e.shrSH=e.toBig=void 0,e.fromBig=o,e.split=n,e.add=b;var s=BigInt(2**32-1),a=BigInt(32);function o(i,r=!1){return r?{h:Number(i&s),l:Number(i>>a&s)}:{h:Number(i>>a&s)|0,l:Number(i&s)|0}}function n(i,r=!1){let t=new Uint32Array(i.length),h=new Uint32Array(i.length);for(let f=0;f<i.length;f++){let{h:g,l:A}=o(i[f],r);[t[f],h[f]]=[g,A]}return[t,h]}var w=(i,r)=>BigInt(i>>>0)<<a|BigInt(r>>>0);e.toBig=w;var v=(i,r,t)=>i>>>t;e.shrSH=v;var C=(i,r,t)=>i<<32-t|r>>>t;e.shrSL=C;var S=(i,r,t)=>i>>>t|r<<32-t;e.rotrSH=S;var l=(i,r,t)=>i<<32-t|r>>>t;e.rotrSL=l;var y=(i,r,t)=>i<<64-t|r>>>t-32;e.rotrBH=y;var k=(i,r,t)=>i>>>t-32|r<<64-t;e.rotrBL=k;var _=(i,r)=>r;e.rotr32H=_;var T=(i,r)=>i;e.rotr32L=T;var E=(i,r,t)=>i<<t|r>>>32-t;e.rotlSH=E;var B=(i,r,t)=>r<<t|i>>>32-t;e.rotlSL=B;var c=(i,r,t)=>r<<t-32|i>>>64-t;e.rotlBH=c;var L=(i,r,t)=>i<<t-32|r>>>64-t;e.rotlBL=L;function b(i,r,t,h){let f=(r>>>0)+(h>>>0);return{h:i+t+(f/2**32|0)|0,l:f|0}}var x=(i,r,t)=>(i>>>0)+(r>>>0)+(t>>>0);e.add3L=x;var P=(i,r,t,h)=>r+t+h+(i/2**32|0)|0;e.add3H=P;var p=(i,r,t,h)=>(i>>>0)+(r>>>0)+(t>>>0)+(h>>>0);e.add4L=p;var u=(i,r,t,h,f)=>r+t+h+f+(i/2**32|0)|0;e.add4H=u;var d=(i,r,t,h,f)=>(i>>>0)+(r>>>0)+(t>>>0)+(h>>>0)+(f>>>0);e.add5L=d;var m=(i,r,t,h,f,g)=>r+t+h+f+g+(i/2**32|0)|0;e.add5H=m;var I={fromBig:o,split:n,toBig:w,shrSH:v,shrSL:C,rotrSH:S,rotrSL:l,rotrBH:y,rotrBL:k,rotr32H:_,rotr32L:T,rotlSH:E,rotlSL:B,rotlBH:c,rotlBL:L,add:b,add3L:x,add3H:P,add4L:p,add4H:u,add5H:m,add5L:d};e.default=I}),oe=j(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.crypto=void 0,e.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0}),he=j(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Hash=e.nextTick=e.byteSwapIfBE=e.byteSwap=e.isLE=e.rotl=e.rotr=e.createView=e.u32=e.u8=void 0,e.isBytes=o,e.byteSwap32=y,e.bytesToHex=_,e.hexToBytes=B,e.asyncLoop=L,e.utf8ToBytes=b,e.toBytes=x,e.concatBytes=P,e.checkOpts=d,e.wrapConstructor=m,e.wrapConstructorWithOpts=I,e.wrapXOFConstructorWithOpts=i,e.randomBytes=r;var s=oe(),a=X();function o(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}var n=t=>new Uint8Array(t.buffer,t.byteOffset,t.byteLength);e.u8=n;var w=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4));e.u32=w;var v=t=>new DataView(t.buffer,t.byteOffset,t.byteLength);e.createView=v;var C=(t,h)=>t<<32-h|t>>>h;e.rotr=C;var S=(t,h)=>t<<h|t>>>32-h>>>0;e.rotl=S,e.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;var l=t=>t<<24&4278190080|t<<8&16711680|t>>>8&65280|t>>>24&255;e.byteSwap=l,e.byteSwapIfBE=e.isLE?t=>t:t=>(0,e.byteSwap)(t);function y(t){for(let h=0;h<t.length;h++)t[h]=(0,e.byteSwap)(t[h])}var k=Array.from({length:256},(t,h)=>h.toString(16).padStart(2,"0"));function _(t){(0,a.bytes)(t);let h="";for(let f=0;f<t.length;f++)h+=k[t[f]];return h}var T={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function E(t){if(t>=T._0&&t<=T._9)return t-T._0;if(t>=T._A&&t<=T._F)return t-(T._A-10);if(t>=T._a&&t<=T._f)return t-(T._a-10)}function B(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);let h=t.length,f=h/2;if(h%2)throw new Error("padded hex string expected, got unpadded hex of length "+h);let g=new Uint8Array(f);for(let A=0,O=0;A<f;A++,O+=2){let U=E(t.charCodeAt(O)),$=E(t.charCodeAt(O+1));if(U===void 0||$===void 0){let Z=t[O]+t[O+1];throw new Error('hex string expected, got non-hex character "'+Z+'" at index '+O)}g[A]=U*16+$}return g}var c=async()=>{};e.nextTick=c;async function L(t,h,f){let g=Date.now();for(let A=0;A<t;A++){f(A);let O=Date.now()-g;O>=0&&O<h||(await(0,e.nextTick)(),g+=O)}}function b(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function x(t){return typeof t=="string"&&(t=b(t)),(0,a.bytes)(t),t}function P(...t){let h=0;for(let g=0;g<t.length;g++){let A=t[g];(0,a.bytes)(A),h+=A.length}let f=new Uint8Array(h);for(let g=0,A=0;g<t.length;g++){let O=t[g];f.set(O,A),A+=O.length}return f}var p=class{clone(){return this._cloneInto()}};e.Hash=p;var u={}.toString;function d(t,h){if(h!==void 0&&u.call(h)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(t,h)}function m(t){let h=g=>t().update(x(g)).digest(),f=t();return h.outputLen=f.outputLen,h.blockLen=f.blockLen,h.create=()=>t(),h}function I(t){let h=(g,A)=>t(A).update(x(g)).digest(),f=t({});return h.outputLen=f.outputLen,h.blockLen=f.blockLen,h.create=g=>t(g),h}function i(t){let h=(g,A)=>t(A).update(x(g)).digest(),f=t({});return h.outputLen=f.outputLen,h.blockLen=f.blockLen,h.create=g=>t(g),h}function r(t=32){if(s.crypto&&typeof s.crypto.getRandomValues=="function")return s.crypto.getRandomValues(new Uint8Array(t));if(s.crypto&&typeof s.crypto.randomBytes=="function")return s.crypto.randomBytes(t);throw new Error("crypto.getRandomValues must be defined")}}),le=j(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.shake256=e.shake128=e.keccak_512=e.keccak_384=e.keccak_256=e.keccak_224=e.sha3_512=e.sha3_384=e.sha3_256=e.sha3_224=e.Keccak=void 0,e.keccakP=L;var s=X(),a=ae(),o=he(),n=[],w=[],v=[],C=BigInt(0),S=BigInt(1),l=BigInt(2),y=BigInt(7),k=BigInt(256),_=BigInt(113);for(let p=0,u=S,d=1,m=0;p<24;p++){[d,m]=[m,(2*d+3*m)%5],n.push(2*(5*m+d)),w.push((p+1)*(p+2)/2%64);let I=C;for(let i=0;i<7;i++)u=(u<<S^(u>>y)*_)%k,u&l&&(I^=S<<(S<<BigInt(i))-S);v.push(I)}var[T,E]=(0,a.split)(v,!0),B=(p,u,d)=>d>32?(0,a.rotlBH)(p,u,d):(0,a.rotlSH)(p,u,d),c=(p,u,d)=>d>32?(0,a.rotlBL)(p,u,d):(0,a.rotlSL)(p,u,d);function L(p,u=24){let d=new Uint32Array(10);for(let m=24-u;m<24;m++){for(let r=0;r<10;r++)d[r]=p[r]^p[r+10]^p[r+20]^p[r+30]^p[r+40];for(let r=0;r<10;r+=2){let t=(r+8)%10,h=(r+2)%10,f=d[h],g=d[h+1],A=B(f,g,1)^d[t],O=c(f,g,1)^d[t+1];for(let U=0;U<50;U+=10)p[r+U]^=A,p[r+U+1]^=O}let I=p[2],i=p[3];for(let r=0;r<24;r++){let t=w[r],h=B(I,i,t),f=c(I,i,t),g=n[r];I=p[g],i=p[g+1],p[g]=h,p[g+1]=f}for(let r=0;r<50;r+=10){for(let t=0;t<10;t++)d[t]=p[r+t];for(let t=0;t<10;t++)p[r+t]^=~d[(t+2)%10]&d[(t+4)%10]}p[0]^=T[m],p[1]^=E[m]}d.fill(0)}var b=class W extends o.Hash{constructor(u,d,m,I=!1,i=24){if(super(),this.blockLen=u,this.suffix=d,this.outputLen=m,this.enableXOF=I,this.rounds=i,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,s.number)(m),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,o.u32)(this.state)}keccak(){o.isLE||(0,o.byteSwap32)(this.state32),L(this.state32,this.rounds),o.isLE||(0,o.byteSwap32)(this.state32),this.posOut=0,this.pos=0}update(u){(0,s.exists)(this);let{blockLen:d,state:m}=this;u=(0,o.toBytes)(u);let I=u.length;for(let i=0;i<I;){let r=Math.min(d-this.pos,I-i);for(let t=0;t<r;t++)m[this.pos++]^=u[i++];this.pos===d&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:u,suffix:d,pos:m,blockLen:I}=this;u[m]^=d,d&128&&m===I-1&&this.keccak(),u[I-1]^=128,this.keccak()}writeInto(u){(0,s.exists)(this,!1),(0,s.bytes)(u),this.finish();let d=this.state,{blockLen:m}=this;for(let I=0,i=u.length;I<i;){this.posOut>=m&&this.keccak();let r=Math.min(m-this.posOut,i-I);u.set(d.subarray(this.posOut,this.posOut+r),I),this.posOut+=r,I+=r}return u}xofInto(u){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(u)}xof(u){return(0,s.number)(u),this.xofInto(new Uint8Array(u))}digestInto(u){if((0,s.output)(u,this),this.finished)throw new Error("digest() was already called");return this.writeInto(u),this.destroy(),u}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(u){let{blockLen:d,suffix:m,outputLen:I,rounds:i,enableXOF:r}=this;return u||(u=new W(d,m,I,r,i)),u.state32.set(this.state32),u.pos=this.pos,u.posOut=this.posOut,u.finished=this.finished,u.rounds=i,u.suffix=m,u.outputLen=I,u.enableXOF=r,u.destroyed=this.destroyed,u}};e.Keccak=b;var x=(p,u,d)=>(0,o.wrapConstructor)(()=>new b(u,p,d));e.sha3_224=x(6,144,224/8),e.sha3_256=x(6,136,256/8),e.sha3_384=x(6,104,384/8),e.sha3_512=x(6,72,512/8),e.keccak_224=x(1,144,224/8),e.keccak_256=x(1,136,256/8),e.keccak_384=x(1,104,384/8),e.keccak_512=x(1,72,512/8);var P=(p,u,d)=>(0,o.wrapXOFConstructorWithOpts)((m={})=>new b(u,p,m.dkLen===void 0?d:m.dkLen,!0));e.shake128=P(31,168,128/8),e.shake256=P(31,136,256/8)}),ue=j((e,s)=>{var{sha3_512:a}=le(),o=24,n=32,w=(c=4,L=Math.random)=>{let b="";for(;b.length<c;)b=b+Math.floor(L()*36).toString(36);return b};function v(c){let L=BigInt(8),b=BigInt(0);for(let x of c.values()){let P=BigInt(x);b=(b<<L)+P}return b}var C=(c="")=>v(a(c)).toString(36).slice(1),S=Array.from({length:26},(c,L)=>String.fromCharCode(L+97)),l=c=>S[Math.floor(c()*S.length)],y=({globalObj:c=typeof global<"u"?global:typeof window<"u"?window:{},random:L=Math.random}={})=>{let b=Object.keys(c).toString(),x=b.length?b+w(n,L):w(n,L);return C(x).substring(0,n)},k=c=>()=>c++,_=476782367,T=({random:c=Math.random,counter:L=k(Math.floor(c()*_)),length:b=o,fingerprint:x=y({random:c})}={})=>function(){let P=l(c),p=Date.now().toString(36),u=L().toString(36),d=w(b,c),m=`${p+d+u+x}`;return`${P+C(m).substring(1,b)}`},E=T(),B=(c,{minLength:L=2,maxLength:b=n}={})=>{let x=c.length,P=/^[a-z][0-9a-z]+$/;try{if(typeof c=="string"&&x>=L&&x<=b&&P.test(c))return!0}finally{}return!1};s.exports.getConstants=()=>({defaultLength:o,bigLength:n}),s.exports.init=T,s.exports.createId=E,s.exports.bufToBigInt=v,s.exports.createCounter=k,s.exports.createFingerprint=y,s.exports.isCuid=B}),D=j((e,s)=>{var{createId:a,init:o,getConstants:n,isCuid:w}=ue();s.exports.createId=a,s.exports.init=o,s.exports.getConstants=n,s.exports.isCuid=w}),de=H(D()),ce={arabic:"ar",armenian:"am",bulgarian:"bg",danish:"dk",dutch:"nl",english:"en",finnish:"fi",french:"fr",german:"de",greek:"gr",hungarian:"hu",indian:"in",indonesian:"id",irish:"ie",italian:"it",lithuanian:"lt",nepali:"np",norwegian:"no",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"rs",slovenian:"ru",spanish:"es",swedish:"se",tamil:"ta",turkish:"tr",ukrainian:"uk",sanskrit:"sk"},fe=Object.keys(ce);Date.now().toString().slice(5);var q=BigInt(1e3),N=BigInt(1e6),F=BigInt(1e9);function pe(e){return typeof e=="number"&&(e=BigInt(e)),e<q?`${e}ns`:e<N?`${e/q}μs`:e<F?`${e/N}ms`:`${e/F}s`}fe.join(`
 - `);function z(e){return{raw:Number(e),formatted:pe(e)}}var G="2.1.4",ge={name:"@oramacloud/client",version:G,description:"Orama SDK client for Node.js, Deno, and Browsers",type:"module",sideEffects:!1,main:"./dist/index.js",module:"./dist/index.js",types:"./dist/index.d.ts",runkitExampleFilename:"./example/runkit.js",exports:{types:"./dist/index.d.ts",browser:{import:"./dist/index.js",require:"./dist/index.global.js"},import:"./dist/index.js",require:"./dist/index.cjs",default:"./dist/index.js"},scripts:{watch:"tsup --config tsup.lib.js --watch src",build:"tsup --config tsup.lib.js",test:'glob -c "node --import tsx --no-warnings --test" "./tests/**/*.test.ts"',"serve:example":"esbuild src/index.ts --bundle --outfile=example/out.js --format=esm --watch --servedir=example"},keywords:["orama","search engine","sdk"],files:["dist","example/runkit.js"],author:{name:"Michele Riva",email:"michele.riva@oramasearch.com",url:"https://github.com/MicheleRiva"},license:"ISC",dependencies:{"@orama/cuid2":"^2.2.3","@orama/orama":"^3.0.0",lodash:"^4.17.21"},devDependencies:{"@fastify/formbody":"^7.4.0","@types/lodash":"^4.14.202","@types/node":"^20.3.1",dotenv:"^16.3.1",esbuild:"0.18.5",fastify:"^4.19.2",glob:"^11.0.0",husky:"^8.0.3","npm-run-all":"^4.1.5","ts-standard":"^12.0.2",tsup:"^8.3.0",tsx:"^4.7.0",typescript:"^5.1.3"},publishConfig:{access:"public"},"ts-standard":{ignore:["dist","node_modules"]}},J=H(D()),me="https://answer.api.orama.com",ye="/v1/indexes",K="orama_user_id";function we(e){let[s,...a]=e.split(`
`),o=a.join(`
`).replace("data: ","");return{event:s.replace("event: ",""),data:o}}function Q(e){return typeof e=="object"?JSON.stringify(e):`${e}`}var be=class{messages;inferenceType;oramaClient;endpoint;abortController;events;userContext;conversationID;lastInteractionParams;state=[];systemPrompts;constructor(e){let s=e.oramaClient.answersApiBaseURL||me;this.messages=e.initialMessages||[],this.inferenceType=e.inferenceType,this.oramaClient=e.oramaClient,this.endpoint=`${s}/v1/answer?api-key=${this.oramaClient.api_key}`,this.events=e.events,this.conversationID=(0,J.createId)(),this.userContext=e.userContext}async askStream(e){return this.messages.push({role:"user",content:e.term??""}),this.fetchAnswer(e)}async ask(e){let s=await this.askStream(e),a="";for await(let o of s)a=o;return this.events?.onMessageChange&&this.events.onMessageChange(this.messages),a}getMessages(){return this.messages}clearSession(){this.messages=[],this.state=[],this.events?.onMessageChange&&this.events.onMessageChange(this.messages),this.events?.onStateChange&&this.events.onStateChange(this.state)}abortAnswer(){if(!this.abortController)throw new Error("AbortController is not ready");this.abortController.abort(),this.abortController=void 0,this.state[this.state.length-1].aborted=!0}async regenerateLast({stream:e=!0}={}){if(this.state.length===0||this.messages.length===0)throw new Error("No messages to regenerate");if(this.messages.at(-1)?.role!=="assistant")throw new Error("Last message is not an assistant message");return this.messages.pop(),this.state.pop(),e?this.askStream(this.lastInteractionParams):this.ask(this.lastInteractionParams)}addNewEmptyAssistantMessage(){this.messages.push({role:"assistant",content:""})}async*fetchAnswer(e){this.abortController=new AbortController,this.lastInteractionParams=e;let s=(0,J.createId)(),a=null,o=this.state.length;this.state.push({interactionId:s,query:e.term??"",response:"",relatedQueries:null,sources:null,translatedQuery:null,segment:null,trigger:null,aborted:!1,loading:!0,error:!1,errorMessage:null});try{this.events?.onNewInteractionStarted&&this.events.onNewInteractionStarted(s),this.events?.onStateChange&&this.events.onStateChange(this.state);let n=new URLSearchParams;n.append("type",this.inferenceType),n.append("messages",JSON.stringify(this.messages)),n.append("query",e.term??""),n.append("conversationId",this.conversationID),n.append("userId",this.oramaClient.getUserId()),n.append("endpoint",this.oramaClient.endpoint),n.append("searchParams",JSON.stringify(e)),n.append("identity",this.oramaClient.getIdentity()??""),n.append("interactionId",s),n.append("alias",this.oramaClient.getAlias()??"");let w=this.getSystemPromptConfiguration();if(w&&n.append("systemPrompts",JSON.stringify(w)),this.userContext&&n.append("userContext",Q(this.userContext)),e.userData&&n.append("userData",Q(e.userData)),e.related){if(e.related?.howMany&&e.related?.howMany>5)throw new Error("Can generate at most 5 related queries");n.append("related",JSON.stringify({enabled:!0,howMany:e.related.howMany??3,format:e.related.format??"question"}))}let v=await fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString(),signal:this.abortController.signal});if(!v.ok||!v.body)throw new Error(v.statusText);a=v.body.getReader();let C=new TextDecoder,S=[],l="";this.events?.onMessageLoading&&this.events.onMessageLoading(!0),this.addNewEmptyAssistantMessage();let y=this.messages.at(-1);for(;;){let{value:k,done:_}=await a.read();if(_)break;l+=C.decode(k,{stream:!0});let T;for(;(T=l.indexOf(`

`))!==-1;){let E=l.slice(0,T);l=l.slice(T+2);try{let B=we(E),c=JSON.parse(B.data);if(c.type==="sources")this.state[o].sources=c.message,this.events?.onSourceChange&&this.events.onSourceChange(c.message),this.events?.onStateChange&&this.events.onStateChange(this.state);else if(c.type==="query-translated")this.state[o].translatedQuery=c.message,this.events?.onQueryTranslated&&this.events.onQueryTranslated(c.message),this.events?.onStateChange&&this.events.onStateChange(this.state);else if(c.type==="conversation-metadata"){let{segment:L,trigger:b}=c.message;L&&(this.state[o].segment=L),b&&(this.state[o].trigger=b),this.events?.onStateChange&&this.events.onStateChange(this.state)}else if(c.type==="related-queries")this.state[o].relatedQueries=c.message,this.events?.onRelatedQueries&&this.events.onRelatedQueries(c.message),this.events?.onStateChange&&this.events.onStateChange(this.state);else if(c.type==="text")for(S.push(c.message);S.length>0;)y.content+=S.shift(),this.state[o].response=y.content,this.events?.onStateChange&&this.events.onStateChange(this.state),this.events?.onMessageChange&&this.events.onMessageChange(this.messages),yield y.content}catch(B){console.error("Error parsing SSE event:",B),console.error("Raw message:",E)}}}}catch(n){if(n.name==="AbortError")this.state[o].aborted=!0,this.events?.onAnswerAborted&&this.events.onAnswerAborted(!0);else throw this.state[o].error=!0,this.state[o].errorMessage=n.message??"Unknown error",n}finally{a?.releaseLock(),this.state[o].loading=!1,this.events?.onStateChange&&this.events.onStateChange(this.state),this.events?.onInteractionDone&&this.events.onInteractionDone(this.state[o]),this.events?.onMessageLoading&&this.events.onMessageLoading(!1)}}setSystemPromptConfiguration(e){if(Array.isArray(e.systemPrompts)){if(!e.systemPrompts.every(s=>typeof s=="string"))throw new Error("Invalid system prompt configuration");this.systemPrompts=e.systemPrompts}return this}getSystemPromptConfiguration(){return this.systemPrompts}},ve=class{cache;config;constructor(e){this.cache=new Map,this.config=e}set(e,s){this.cache.set(e,s)}get(e){return this.cache.get(e)}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}};function R(e,s){if(typeof navigator<"u"){typeof navigator.sendBeacon<"u"&&navigator.sendBeacon(e,s);return}fetch(e,{method:"POST",body:s,headers:{"Content-Type":"application/json"}}).then(()=>{},a=>console.log(a))}var Se=class Y{data;params;config;profile;constructor(s,a){this.data=[],this.config=s,this.profile=a}setParams(s){this.params=s}static create(s,a){let o=new Y(s,a);return o.start(),o}add(s){this.data.push({rawSearchString:s.rawSearchString,query:s.query,resultsCount:s.resultsCount,roundTripTime:s.roundTripTime,searchedAt:s.searchedAt,userId:this.profile.getUserId(),identity:this.profile.getIdentity(),alias:this.profile.getAlias(),referer:typeof location<"u"?location.toString():void 0}),this.params!=null&&this.data.length>=this.config.flushSize&&this.flush()}flush(){if(this.params==null||this.data.length===0)return;let s=this.data;this.data=[];let a={source:"fe",deploymentID:this.params.deploymentID,index:this.params.index,oramaId:this.config.id,oramaVersion:ge.version,userAgent:typeof navigator<"u"?navigator.userAgent:void 0,events:s};R(`${this.params.endpoint}?api-key=${this.config.api_key}`,JSON.stringify(a))?.catch(o=>console.log(o))}start(){let s=setInterval(this.flush.bind(this),this.config.flushInterval);s.unref!=null&&s.unref()}},Ie=class{constructor(e){this.params=e}intervalId;start(){this.stop(),this.intervalId=setInterval(this.beat.bind(this),this.params.frequency)}stop(){this.intervalId!==void 0&&clearInterval(this.intervalId)}beat(){R(this.params.endpoint)?.catch(e=>console.log(e))}},M=H(D()),ke=class{endpoint;apiKey;userId;identity;userAlias;params;constructor({endpoint:e,apiKey:s}){if(!e||!s)throw new Error("Endpoint and API Key are required to create a Profile");if(typeof e!="string"||typeof s!="string")throw new Error("Endpoint and API Key must be strings");if(typeof localStorage<"u"){let a=localStorage.getItem(K);a?this.userId=a:(this.userId=(0,M.createId)(),localStorage.setItem(K,this.userId))}else this.userId=(0,M.createId)();this.endpoint=e,this.apiKey=s}setParams(e){let{protocol:s,host:a}=new URL(e.identifyUrl),o=`${s}//${a}/identify`;this.params={identifyUrl:o,index:e.index}}getIdentity(){return this.identity}getUserId(){return this.userId}getAlias(){return this.userAlias}async sendProfileData(e){if(!this.params)throw new Error("Orama Profile is not initialized");let s=JSON.stringify({...e,visitorId:this.getUserId(),index:this.params.index});await R(`${this.params?.identifyUrl}?api-key=${this.apiKey}`,s)}async identify(e,s){if(typeof s!="string")throw new Error("Identity must be a string");await e,await this.sendProfileData({entity:"identity",id:s}),this.identity=s}async alias(e,s){if(typeof s!="string")throw new Error("Identity must be a string");await e,await this.sendProfileData({entity:"alias",id:s}),this.userAlias=s}reset(){this.userId=(0,M.createId)(),this.identity=void 0,this.userAlias=void 0}};function xe(e){return e!==void 0&&e?.signal!==void 0}var Ce=class{id=(0,de.createId)();api_key;endpoint;multiIndexSearch;mergeResults;multiIndexIndexes;answersApiBaseURL;collector;cache;profile;searchDebounceTimer;searchRequestCounter=0;blockSearchTillAuth=!1;heartbeat;initPromise;constructor(e){if("indexes"in e){this.api_key=e.indexes[0].api_key,this.multiIndexIndexes=e.indexes;let s=new URL(e.indexes[0].endpoint).origin;if(e.indexes.some(a=>new URL(a.endpoint).origin!==s))throw new Error("All indexes must have the same endpoint origin");this.endpoint=s+ye,this.multiIndexSearch=!0,this.mergeResults=e.mergeResults??!0}else this.api_key=e.api_key,this.endpoint=e.endpoint,this.multiIndexSearch=!1,this.mergeResults=!0;if(this.answersApiBaseURL=e.answersApiBaseURL,this.profile=new ke({endpoint:this.endpoint,apiKey:this.api_key}),e.telemetry!==!1){let s={id:this.id,api_key:this.api_key,flushInterval:e.telemetry?.flushInterval??5e3,flushSize:e.telemetry?.flushSize??25};this.collector=Se.create(s,this.profile)}if(e.cache!==!1){let s={};this.cache=new ve(s)}this.init()}customerUserToken=void 0;searchToken=void 0;setAuthToken(e){e===null?(this.customerUserToken=void 0,this.searchToken=void 0):(this.customerUserToken=e,this.searchToken=void 0),this.init()}onAuthTokenExpired;setOnAuthTokenExpired(e){this.onAuthTokenExpired=e}addSearchResultsToCollector(e,s,a,o){if(this.collector)if(Array.isArray(e))for(let n of e)this.collector.add({rawSearchString:a.term,resultsCount:n.hits?.length??0,roundTripTime:s,query:a,cached:o,searchedAt:new Date,userId:this.profile.getUserId()});else this.collector.add({rawSearchString:a.term,resultsCount:e?.hits?.length??0,roundTripTime:s,query:a,cached:o,searchedAt:new Date,userId:this.profile.getUserId()})}async search(e,s){if(await this.initPromise,this.blockSearchTillAuth)return console.warn("Search request blocked until user is authenticated"),null;let a=++this.searchRequestCounter,o=`search-${JSON.stringify(e)}`,n=null,w,v=!1,C=s?.fresh!==!0&&this.cache?.has(o),S=async()=>{try{let l=Date.now();this.multiIndexSearch?n=await this.fetch("multi_search","POST",{q:{...e,mergeResults:this.mergeResults},sst:this.searchToken,indexes:this.multiIndexIndexes},s?.abortController):n=await this.fetch("search","POST",{q:e,sst:this.searchToken},s?.abortController);let y=Date.now();w=y-l;let k=await z(BigInt(y*1e6-l*1e6));if(!Array.isArray(n))n.elapsed=k;else for(let _ of n)_.elapsed=k;this.cache?.set(o,n)}catch(l){if(l.name!=="AbortError")throw console.error("Search request failed",l),l}return this.addSearchResultsToCollector(n,w,e,v),n};if(C&&this.cache)w=0,n=this.cache.get(o),v=!0,this.addSearchResultsToCollector(n,w,e,v);else return s?.debounce?new Promise((l,y)=>{clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=setTimeout(async()=>{try{await S(),l(n)}catch(k){k.name!=="AbortError"&&(console.error("Search request failed",k),y(k))}},s?.debounce||300),"unref"in this.searchDebounceTimer&&this.searchDebounceTimer.unref()}):S();return a===this.searchRequestCounter?n:null}async vectorSearch(e,s){await this.initPromise;let a=`vectorSearch-${JSON.stringify(e)}`,o,n,w=!1;if((s?.fresh!==!0&&this.cache?.has(a))===!0&&this.cache!=null)o=0,n=this.cache.get(a),w=!0;else{let v=Date.now();n=await this.fetch("vector-search2","POST",{q:e},s?.abortSignal??s?.abortController);let C=Date.now();n.elapsed=await z(BigInt(C*1e6-v*1e6)),o=C-v,this.cache?.set(a,n)}return this.collector!=null&&this.collector.add({rawSearchString:e.term,resultsCount:n.hits?.length??0,roundTripTime:o,query:e,cached:w,searchedAt:new Date,userId:this.profile.getUserId()}),n}createAnswerSession(e){return new be({inferenceType:e?.inferenceType||"documentation",initialMessages:e?.initialMessages||[],oramaClient:this,events:e?.events,userContext:e?.userContext,systemPrompts:e?.systemPrompts??[]})}startHeartBeat(e){this.heartbeat?.stop(),this.heartbeat=new Ie({...e,endpoint:`${this.endpoint}/health?api-key=${this.api_key}`}),this.heartbeat.start()}stopHeartBeat(){this.heartbeat?.stop()}async getPop(){return(await this.initPromise)?.pop??""}expirationTimer;init(){let e=["init","GET",void 0,void 0,{token:this.customerUserToken}];this.multiIndexSearch&&(e=["init_multi_search","POST",{indexes:this.multiIndexIndexes},void 0,{token:this.customerUserToken}]),this.initPromise=this.fetch(...e).then(s=>{if(this.collector?.setParams({endpoint:s.collectUrl,deploymentID:s.deploymentID,index:s.index}),this.profile?.setParams({identifyUrl:s.collectUrl,index:s.index}),s.searchSession){if("required"in s.searchSession&&s.searchSession.required===!0)this.blockSearchTillAuth=!0;else if("token"in s.searchSession){let a=s.searchSession.token;this.searchToken=a;let o=s.searchSession.maxAge;this.blockSearchTillAuth=!1,this.expirationTimer&&clearTimeout(this.expirationTimer),this.expirationTimer=setTimeout(()=>{this.searchToken===a&&(this.searchToken=void 0,this.blockSearchTillAuth=!0,this.onAuthTokenExpired?.(a))},o*1e3),"unref"in this.expirationTimer&&this.expirationTimer.unref()}}return s}).catch(s=>(console.log(s),null))}async fetch(e,s,a,o,n){let w=xe(o)?o?.signal:o;if(w?.aborted===!0)throw new Error("Request aborted");let v={method:s,headers:{"Content-Type":"application/x-www-form-urlencoded"},signal:w};if(s==="POST"&&a!==void 0){let l=a;l.version=G,l.id=this.id,l.visitorId=this.profile.getUserId(),v.body=Object.entries(l).filter(([y,k])=>!!k).map(([y,k])=>`${y}=${encodeURIComponent(JSON.stringify(k))}`).join("&")}let C=new URL(`${this.endpoint}/${e}`);if(this.multiIndexSearch||C.searchParams.append("api-key",this.api_key),n)for(let[l,y]of Object.entries(n))y&&C.searchParams.append(l,y);let S=await fetch(C,v);if(!S.ok){let l=new Error;throw l.httpResponse=S,l}return await S.json()}getIdentity(){return this.profile.getIdentity()}getUserId(){return this.profile.getUserId()}getAlias(){return this.profile.getAlias()}async identify(e){if(this.initPromise===void 0)throw new Error("OramaClient not initialized");await this.profile.identify(this.initPromise,e)}async alias(e){if(this.initPromise===void 0)throw new Error("OramaClient not initialized");await this.profile.alias(this.initPromise,e)}reset(){this.profile.reset()}};/*! Bundled license information:

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/export{Ce as I};
